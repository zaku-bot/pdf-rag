import json
import numpy as np
import faiss

# File paths
faiss_index_file = "../faiss_storage/faiss_index.idx"
mapping_file = "../faiss_storage/embeddings_with_vectors.json"
papers_data_json = "../pdf_scraping/combined_data.json"

# Load data
def load_json(file_path):
    with open(file_path, 'r') as f:
        mapping = json.load(f)
    return mapping


# Load FAISS index
def load_faiss_index(index_file):
    return faiss.read_index(index_file)

# Search for most similar papers/sections based on input vector
def search_similar_papers(query_vector, faiss_index, paper_map, k=3):
    # Ensure query vector is in the correct shape (1, dim)
    query_vector = np.array(query_vector, dtype='float32').reshape(1, -1)

    # Search the FAISS index for the nearest neighbors
    distances, indices = faiss_index.search(query_vector, k)

    # Map the indices back to the paper IDs and section names
    results = []
    for i in range(k):
        idx = indices[0][i]
        if idx != -1:  # Check if a valid result was found
            result = paper_map[str(idx)]  # Paper map uses strings as keys
            results.append({
                "paper_id": result["paper_id"],
                "section_name": result["section_name"],
                "distance": distances[0][i]
            })

    return results

# Main workflow
if __name__ == "__main__":
    # Load the FAISS index and paper map (embeddings with paper info)
    faiss_index = load_faiss_index(faiss_index_file)
    paper_map = load_json(mapping_file)
    papers_data = load_json(papers_data_json)

    # Example query vector (replace with your own embedding)
    query_vector = [
            0.09760810434818268,
            0.24379077553749084,
            -0.09340451657772064,
            -0.22694213688373566,
            -0.07435690611600876,
            0.18642638623714447,
            -0.14077170193195343,
            0.3700452744960785,
            0.4079229235649109,
            -0.030495936051011086,
            -0.1032211035490036,
            0.16173020005226135,
            -0.024186935275793076,
            0.029794225469231606,
            0.36760413646698,
            0.061282623559236526,
            -0.03585667535662651,
            -0.14884281158447266,
            0.046342454850673676,
            -0.009132027626037598,
            0.1909017562866211,
            0.23700138926506042,
            0.08960115164518356,
            0.10889925807714462,
            -0.074180006980896,
            0.14514808356761932,
            -0.34350070357322693,
            0.011958139948546886,
            0.4703660309314728,
            -0.23283301293849945,
            0.0160056184977293,
            0.07335058599710464,
            0.10272423923015594,
            -0.0037879711017012596,
            -0.0032122309785336256,
            -0.3241434693336487,
            0.030316801741719246,
            0.07415193319320679,
            0.2052735537290573,
            -0.5354301333427429,
            -0.1042494848370552,
            -0.12498046457767487,
            -0.03810654580593109,
            0.076106958091259,
            0.16411851346492767,
            -0.04855233058333397,
            0.019847309216856956,
            -0.16456139087677002,
            -0.3985467851161957,
            0.025766760110855103,
            -0.3258812427520752,
            0.1203862652182579,
            -0.22093071043491364,
            -0.17435124516487122,
            -0.35331133008003235,
            0.1322510689496994,
            -0.11358242481946945,
            -0.1416429728269577,
            0.3671095073223114,
            0.12986105680465698,
            0.19692127406597137,
            0.09158527106046677,
            0.08539517968893051,
            0.25400373339653015,
            0.0909021869301796,
            -0.08031327277421951,
            0.04062435030937195,
            0.4286124110221863,
            -0.44152411818504333,
            -0.34278762340545654,
            -0.20536383986473083,
            0.006765544880181551,
            -0.008017702959477901,
            0.30036985874176025,
            -0.20770305395126343,
            0.26373133063316345,
            -0.15589722990989685,
            0.03169988468289375,
            0.01588994637131691,
            0.04136775806546211,
            0.06295369565486908,
            0.1465405970811844,
            0.13445724546909332,
            0.10466611385345459,
            0.02929508686065674,
            0.43872007727622986,
            0.13310213387012482,
            -0.3043026030063629,
            0.24818368256092072,
            0.19638174772262573,
            -0.06711860746145248,
            -0.1190871000289917,
            -1.0488171577453613,
            0.0029197740368545055,
            -0.26887866854667664,
            -0.09858612716197968,
            -0.050615742802619934,
            0.1393943876028061,
            0.011589194647967815,
            -0.16645781695842743,
            -0.1938646137714386,
            -0.009724350646138191,
            -0.1880923956632614,
            -0.02377878688275814,
            0.04793277010321617,
            -0.4499146342277527,
            -0.6293409466743469,
            0.2963481545448303,
            0.3685697317123413,
            0.03677434101700783,
            0.16373981535434723,
            -1.0424758195877075,
            0.16104519367218018,
            -0.20557889342308044,
            0.35930490493774414,
            0.24217979609966278,
            -0.1497116982936859,
            0.12031331658363342,
            -0.06727626174688339,
            0.1294502317905426,
            0.14380645751953125,
            0.03618341684341431,
            -0.18182404339313507,
            0.08655353635549545,
            0.15216346085071564,
            -0.12522773444652557,
            0.39538294076919556,
            0.15729846060276031,
            0.3571120500564575,
            0.06297807395458221,
            0.06386641412973404,
            -0.43294042348861694,
            -0.14815092086791992,
            5.372303485870361,
            -0.004038757644593716,
            0.3863446116447449,
            -0.41419583559036255,
            -0.4836564362049103,
            -0.3284859359264374,
            0.21337613463401794,
            0.4559997022151947,
            -0.22899092733860016,
            -0.3031097948551178,
            -0.13422435522079468,
            0.02857361175119877,
            0.3417484164237976,
            0.23992864787578583,
            -0.5195206999778748,
            -0.14140383899211884,
            0.1554565131664276,
            -0.3273969888687134,
            0.2134607434272766,
            0.20721454918384552,
            0.7140294313430786,
            -0.30041107535362244,
            -0.471205472946167,
            -0.16109256446361542,
            -0.06505059450864792,
            0.15728497505187988,
            0.45309674739837646,
            0.11122751235961914,
            0.012496239505708218,
            0.04352471977472305,
            0.24663768708705902,
            -0.23598229885101318,
            0.19962342083454132,
            0.2138707935810089,
            0.3787676692008972,
            0.06916634738445282,
            0.10775429755449295,
            0.15575939416885376,
            0.34005600214004517,
            0.2390095740556717,
            -0.10988588631153107,
            0.3822648525238037,
            -0.25214385986328125,
            0.23891203105449677,
            -0.2641821503639221,
            0.6541218161582947,
            -0.09837312996387482,
            -0.400791734457016,
            -0.17703956365585327,
            -0.11111006140708923,
            -0.042994286864995956,
            -0.8017586469650269,
            0.40873467922210693,
            -0.031530462205410004,
            0.2342195212841034,
            -0.16027674078941345,
            0.331161767244339,
            0.40495961904525757,
            -0.3188037872314453,
            -0.1341818869113922,
            -0.023179667070508003,
            0.24245643615722656,
            -0.14375583827495575,
            0.20819157361984253,
            0.2078295201063156,
            -0.032175421714782715,
            -0.008953460492193699,
            0.3561636209487915,
            -0.1082642525434494,
            -0.3484037220478058,
            0.3480948209762573,
            -0.3464771807193756,
            -0.4951612055301666,
            0.2068774551153183,
            0.17771680653095245,
            -0.2918734550476074,
            -0.02961542271077633,
            -0.12420835345983505,
            -0.10346069186925888,
            0.2069540172815323,
            0.2828329801559448,
            0.24292615056037903,
            0.06596358120441437,
            0.3014501929283142,
            -0.23463913798332214,
            0.34745359420776367,
            0.1572396606206894,
            0.39830282330513,
            -0.2893655598163605,
            -0.2610924541950226,
            0.23333123326301575,
            0.03823452442884445,
            -0.30339646339416504,
            0.22173354029655457,
            0.003635191358625889,
            0.3915475010871887,
            -0.2084345817565918,
            -0.13166682422161102,
            0.47312211990356445,
            0.1702709197998047,
            0.2557499408721924,
            0.13820791244506836,
            -0.38231161236763,
            -0.19306938350200653,
            0.26850491762161255,
            0.05964303016662598,
            -0.044527094811201096,
            0.3529910147190094,
            -0.21198208630084991,
            0.2710665464401245,
            -0.26444777846336365,
            -0.29199138283729553,
            0.9348639249801636,
            0.3991342782974243,
            0.25832316279411316,
            -0.2007453441619873,
            0.26106274127960205,
            -0.3109479248523712,
            0.14717115461826324,
            0.20063142478466034,
            -0.15978021919727325,
            -0.30351048707962036,
            -0.180006742477417,
            -0.25364500284194946,
            0.3138006031513214,
            -0.004242594353854656,
            0.6448530554771423,
            -0.13307468593120575,
            -0.38981693983078003,
            0.11565989255905151,
            0.2705022990703583,
            -0.24257543683052063,
            -0.27108243107795715,
            0.033233482390642166,
            0.15973183512687683,
            -0.07615012675523758,
            -0.11095403879880905,
            -0.08612719923257828,
            -0.14468109607696533,
            0.039190422743558884,
            0.3932049870491028,
            0.08090948313474655,
            0.5951288342475891,
            -0.10337942838668823,
            0.2342427670955658,
            -0.4512287378311157,
            0.11992842704057693,
            -0.08250604569911957,
            -0.3038724660873413,
            -0.3500085473060608,
            0.17390136420726776,
            -0.015632562339305878,
            0.07556755095720291,
            0.02382020838558674,
            -0.1547946035861969,
            0.06960569322109222,
            -0.13017936050891876,
            -0.14267005026340485,
            -0.1647617518901825,
            -0.03967919945716858,
            0.1485975682735443,
            -0.4730058014392853,
            -0.1607659012079239,
            -0.03981100767850876,
            0.19578616321086884,
            -0.19360092282295227,
            -0.020245153456926346,
            -0.15645980834960938,
            -0.13356982171535492,
            -0.20620518922805786,
            0.2819855809211731,
            0.038275156170129776,
            0.0025146626867353916,
            0.4053153395652771,
            0.09601246565580368,
            0.0003123886708635837,
            -0.10271388292312622,
            -0.09470746666193008,
            0.10032949596643448,
            5.383038520812988,
            -0.10790900141000748,
            0.1828794628381729,
            0.3807191252708435,
            0.17525522410869598,
            -0.033772215247154236,
            -0.34716275334358215,
            -0.10133480280637741,
            -0.3946501612663269,
            0.3199842572212219,
            0.48274126648902893,
            -0.41120660305023193,
            -0.20156262814998627,
            -0.21293795108795166,
            -0.14113695919513702,
            -0.20800119638442993,
            -0.13543209433555603,
            -1.0403465032577515,
            0.3780992031097412,
            0.056610606610774994,
            0.21414971351623535,
            -0.23887673020362854,
            -0.19762109220027924,
            0.12853683531284332,
            -0.3416312336921692,
            0.17470604181289673,
            -0.025846371427178383,
            0.03490830957889557,
            0.2542998790740967,
            0.04097117856144905,
            0.2695978879928589,
            -0.16857469081878662,
            0.055260781198740005,
            0.019016960635781288,
            0.25905272364616394,
            -0.4805028438568115,
            0.56565922498703,
            -0.05602898821234703,
            0.04954947158694267,
            0.1075921356678009,
            -0.2170601338148117,
            0.11466487497091293,
            -0.2083100974559784,
            -0.242237851023674,
            0.10953839123249054,
            -0.28080153465270996,
            0.29435494542121887,
            0.0210888609290123,
            0.4486400783061981,
            0.1286689192056656,
            0.16040141880512238,
            -0.07566792517900467,
            -0.4972926378250122,
            -0.44208037853240967,
            0.41396623849868774,
            0.16966402530670166,
            0.16787424683570862,
            -0.11191364377737045,
            -0.18819405138492584,
            0.005841834470629692,
            -0.2949565649032593,
            0.1856367290019989,
            0.16550306975841522,
            0.6033027768135071,
            0.29114535450935364,
            -0.4566730260848999,
            -0.1493503451347351,
            -0.15136972069740295,
            -0.4361141324043274,
            -0.3945256471633911,
            0.3406345546245575,
            -0.2687399089336395,
            -0.3870197534561157,
            0.43625274300575256,
            0.28058192133903503,
            -0.06768383085727692,
            -0.13997404277324677,
            0.2221239060163498,
            -0.1037917211651802,
            -0.1044018492102623,
            -0.3170149028301239,
            -0.0940437763929367,
            0.6201267242431641,
            0.11975914984941483,
            -0.1875350922346115,
            -0.0868951678276062,
            0.0013017542660236359,
            0.08708106726408005,
            0.10043033212423325,
            0.020688839256763458,
            -0.06104221194982529,
            0.01701434515416622,
            0.308167427778244,
            -0.1762535125017166,
            -0.2725035846233368,
            -0.23684121668338776,
            -0.05533420667052269,
            0.01846499927341938,
            0.0935698002576828,
            -0.08079224079847336,
            0.1430947482585907,
            0.24479684233665466,
            -0.062291476875543594,
            -0.2990829646587372,
            0.03646431863307953,
            0.0733744278550148,
            -0.28845643997192383,
            -0.026869678869843483,
            -0.39192789793014526,
            -0.19015558063983917,
            0.2500874698162079,
            -0.47103214263916016,
            0.018904414027929306,
            -0.7907603979110718,
            0.08958625048398972,
            -0.24723540246486664,
            -0.16450203955173492,
            -0.3573729991912842,
            -0.04912487044930458,
            0.13270340859889984,
            -0.216806560754776,
            0.36656513810157776,
            0.08157338947057724,
            -0.33442768454551697,
            -0.16661125421524048,
            -0.23815341293811798,
            0.3091292083263397,
            -0.12922309339046478,
            -0.12956145405769348,
            -0.2198411226272583,
            0.479038804769516,
            -0.06630255281925201,
            -0.01784166879951954,
            -0.196295827627182,
            0.08223006129264832,
            0.128770112991333,
            -0.15158183872699738,
            0.0017762016505002975,
            -0.27158287167549133,
            0.10258070379495621,
            -0.3298133611679077,
            0.3576698899269104,
            0.2816843092441559,
            -0.1723657101392746,
            -0.08890769630670547,
            0.21925178170204163,
            0.03455832600593567,
            -0.19137340784072876,
            0.23706772923469543,
            -0.18938125669956207,
            -0.22004914283752441,
            -0.0967264324426651,
            0.2971479296684265,
            0.34447547793388367,
            0.10701733082532883,
            -0.2272716611623764,
            0.18000447750091553,
            0.0233403742313385,
            -0.22432322800159454,
            0.4114691913127899,
            0.050944734364748,
            -0.2961503863334656,
            0.0025966179091483355,
            -0.06207562983036041,
            0.024279652163386345,
            -0.2121184915304184,
            -0.07694787532091141,
            0.09239790588617325,
            0.0666254311800003,
            -0.9245855808258057,
            0.24887381494045258,
            -0.06496480852365494,
            0.6989625096321106,
            0.11738765984773636,
            -0.07905326038599014,
            -0.1723197102546692,
            -0.06409929692745209,
            0.19788071513175964,
            0.31503793597221375,
            -0.2133791148662567,
            0.034408215433359146,
            0.5920806527137756,
            0.09752058237791061,
            -0.29177021980285645,
            0.6666572093963623,
            0.224680557847023,
            -0.40510985255241394,
            -0.36177492141723633,
            -0.04187552630901337,
            -0.022471968084573746,
            0.03921660780906677,
            0.13433893024921417,
            0.5315943956375122,
            0.1981498748064041,
            0.011029829271137714,
            0.3475026786327362,
            0.14504465460777283,
            -0.03347380831837654,
            -0.06431499868631363,
            -0.5162167549133301
        ]  # Replace with the actual embedding

    # Search for the 3 most similar papers/sections
    similar_papers = search_similar_papers(query_vector, faiss_index, paper_map, k=1)

    
    
    # Print results
    for i, result in enumerate(similar_papers, 1):
        print(f"Rank {i}: Paper ID: {result['paper_id']}, Section: {result['section_name']}, Distance: {result['distance']}")

        paper_id = result["paper_id"]
        section_name = result["section_name"]
        
        # Fetch content based on section type (abstract or other sections)
        if section_name == "abstract":
            content = papers_data[paper_id]["abstract"]
        else:
            content = papers_data[paper_id]["sections"].get(section_name, "Section not found")
        print(f"Content: {content}")